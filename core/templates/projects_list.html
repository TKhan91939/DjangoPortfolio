{% extends "base.html" %}
{% block title %}Projects â€” Portfolio{% endblock %}
{% block hero %}{% endblock %}

{% block content %}
<section class="mt-2">
  <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
    {% for p in projects %}
      <article class="group rounded-3xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/60 backdrop-blur shadow-sm hover:shadow-md transition overflow-hidden">
        <!-- Cover image from Project.img -->
        <div class="relative aspect-[16/9] overflow-hidden bg-gradient-to-br from-indigo-500/20 via-violet-500/20 to-fuchsia-500/20">
          {% if p.img %}
            <img src="{{ p.img }}" alt="{{ p.name }}" class="absolute inset-0 h-full w-full object-cover" loading="lazy">
          {% endif %}
        </div>

        <div class="p-6">
          <header class="flex items-start justify-between gap-4">
            <h3 class="text-xl font-bold leading-tight">{{ p.name }}</h3>

            {% if p.link %}
              <!-- Clickable GitHub -->
              <a href="{{ p.link }}" target="_blank" rel="noopener"
                 class="inline-flex items-center gap-2 rounded-xl px-3 py-1.5 text-sm
                        border border-neutral-200 dark:border-neutral-800
                        bg-white/70 dark:bg-neutral-900/60
                        hover:shadow-glow hover:border-indigo-400 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .5C5.73.5.98 5.25.98 11.52c0 4.86 3.15 8.98 7.51 10.43.55.1.75-.24.75-.53 0-.26-.01-1.14-.02-2.07-3.05.66-3.7-1.3-3.7-1.3-.5-1.26-1.23-1.6-1.23-1.6-.99-.68.08-.67.08-.67 1.1.08 1.68 1.13 1.68 1.13.98 1.67 2.57 1.19 3.2.91.1-.71.38-1.19.69-1.47-2.44-.28-5.01-1.22-5.01-5.44 0-1.2.43-2.18 1.13-2.95-.11-.28-.49-1.4.11-2.92 0 0 .93-.3 3.04 1.13.88-.25 1.83-.37 2.77-.37s1.89.12 2.77.37c2.11-1.43 3.04-1.13 3.04-1.13.6 1.52.22 2.64.11 2.92.7.77 1.13 1.75 1.13 2.95 0 4.23-2.58 5.16-5.03 5.43.39.34.73 1.01.73 2.04 0 1.47-.01 2.66-.01 3.02 0 .29.2.64.76.53 4.35-1.45 7.49-5.57 7.49-10.43C23.02 5.25 18.27.5 12 .5z"/></svg>
                GitHub
              </a>
            {% endif %}
          </header>

          {% if p.description %}
            <p class="mt-3 text-sm text-neutral-700 dark:text-neutral-300">{{ p.description }}</p>
          {% endif %}

          {% if p.developers %}
            <div class="mt-5">
              <div class="text-xs uppercase tracking-wide text-neutral-500 mb-2">Developers</div>
              <ul class="flex flex-wrap gap-2">
                {% for d in p.developers %}
                  <li class="inline-flex items-center gap-2 rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/60 px-2 py-1">
                    {% if d.img %}
                      <img src="{{ d.img }}" alt="{{ d.first_name }} {{ d.last_name }}"
                           class="h-8 w-8 rounded-full object-cover border border-white/70 dark:border-neutral-800"/>
                    {% else %}
                      <div class="h-8 w-8 rounded-full bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center text-xs font-semibold">
                        {{ d.first_name|default:"?"|first|upper }}{{ d.last_name|default:"?"|first|upper }}
                      </div>
                    {% endif %}
                    <span class="text-xs font-medium">{{ d.first_name }} {{ d.last_name }}</span>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if p.gist %}
            <div class="mt-6">
              <div class="flex items-center justify-between">
                <div class="text-xs uppercase tracking-wide text-neutral-500">Code Preview</div>
                <button class="text-xs rounded-lg border border-neutral-200 dark:border-neutral-800 px-2 py-1 hover:bg-white/60 dark:hover:bg-white/10 transition"
                        data-gist-toggle>
                  Show/Hide
                </button>
              </div>
              <div class="mt-3 rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/60 p-3 overflow-hidden"
                   data-gist-container>
                <!-- Accepts full Gist URL, .js URL, or 'username/gistid' -->
                <div data-gist="{{ p.gist }}"></div>
              </div>
            </div>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  // Convert your saved value into an embed JS src:
  // - Full Gist page URL: https://gist.github.com/USER/ID   -> https://gist.github.com/USER/ID.js
  // - JS URL already:     https://gist.github.com/USER/ID.js -> (keep)
  // - "USER/ID" string:                                    -> https://gist.github.com/USER/ID.js
  function gistToScriptSrc(value) {
    if (!value) return null;

    // USER/ID only?
    if (!value.startsWith('http')) {
      const parts = value.split('/').filter(Boolean);
      if (parts.length >= 2) return `https://gist.github.com/${parts[0]}/${parts[1]}.js`;
      return null;
    }

    try {
      const u = new URL(value);
      if (u.pathname.endsWith('.js')) return value; // already embed

      const parts = u.pathname.split('/').filter(Boolean);
      // Expect .../USER/ID
      const id = parts.pop();
      const user = parts.pop();
      if (!user || !id) return null;

      const file = u.searchParams.get('file');
      const base = `https://gist.github.com/${user}/${id}.js`;
      return file ? `${base}?file=${encodeURIComponent(file)}` : base;
    } catch {
      return null;
    }
  }

  // Embed all gists
  document.querySelectorAll('[data-gist]').forEach(holder => {
    const src = gistToScriptSrc(holder.getAttribute('data-gist'));
    if (!src) return;
    const s = document.createElement('script');
    s.type = 'text/javascript';
    s.src = src;
    holder.innerHTML = '';
    holder.appendChild(s);
  });

  // Show/Hide toggles
  document.querySelectorAll('[data-gist-toggle]').forEach(btn => {
    btn.addEventListener('click', () => {
      const container = btn.closest('div').parentElement.querySelector('[data-gist-container]');
      container.classList.toggle('hidden');
    });
  });
</script>
{% endblock %}
